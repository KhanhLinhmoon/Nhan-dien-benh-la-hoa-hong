<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phát hiện bệnh trên lá cây hoa hồng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-image: url('static/images/background.jpg');
            background-attachment: fixed;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: #28a745;
            border-radius: 0;
            width: 100%;
            margin-bottom: 0;
            padding: 10px 0;
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .nav-link:hover {
            color: #f8f9fa !important;
            text-decoration: underline;
        }
        .active {
            font-weight: bold;
            background-color: #218838;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        #detect-table {
            border-collapse: collapse !important;
            margin: 25px 0 !important;
            font-size: 1.2em !important;
            font-family: sans-serif !important;
            min-width: 400px !important;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15) !important;
            width: 100% !important;
            background-color: transparent !important;
        }
        #detect-table thead tr {
            background-color: #009879 !important;
            color: #ffffff !important;
            text-align: center !important;
        }
        #detect-table tbody tr {
            border-bottom: 1px solid #dddddd !important;
            background-color: transparent !important;
        }
        #detect-table tbody tr:nth-of-type(even) {
            background-color: #77c274 !important;
        }
        #detect-table tbody tr:nth-of-type(odd) {
            background-color: #599c54 !important;
        }
        #detect-table tbody tr:last-of-type {
            border-bottom: 2px solid #009879 !important;
        }
        #detect-table th:nth-child(1), #detect-table td:nth-child(1) { width: 5%; text-align: center !important; }
        #detect-table th:nth-child(2), #detect-table td:nth-child(2) { width: 15%; }
        #detect-table th:nth-child(3), #detect-table td:nth-child(3),
        #detect-table th:nth-child(4), #detect-table td:nth-child(4) { width: 40%; word-wrap: break-word !important; max-width: 35%; }
        .img-thumbnail {
            max-width: 100%;
            height: auto;
        }
        .history-img {
            width: 100px;
            height: auto;
        }
        #detect-section {
            background-color: transparent;
            border: none;
            padding: 0;
        }
        .text-center-custom {
            text-align: center;
            margin-top: 20px;
        }
        /* Đảm bảo không in đậm */
        #detect-table td {
            font-weight: normal !important; /* Loại bỏ in đậm */
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark">
            <a class="navbar-brand" href="#">NHẬN DIỆN BỆNH HOA HỒNG</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('detect-section')">Nhận diện bệnh</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('history-section')">Lịch sử nhận diện</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('handbook-section')">Sổ tay nhận diện</a>
                    </li>
                </ul>
            </div>
        </nav>

        <h1 id="section-title" style="margin-top: 20px; text-align: center; font-family: Verdana, Arial, Helvetica, sans-serif;"></h1>

        <div id="detect-section" class="content-section active">
            <div class="row">
                <div class="col">
                    <div class="text-center">
                        <form id="detectForm" action="/detect" method="POST" enctype="multipart/form-data">
                            <input type="file" id="img" name="file" accept="image/*" onchange="readPath(event)">
                            <button type="button" class="btn btn-primary" onclick="sendImage()">Nhận diện</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-6 text-center">
                    <h5>Ảnh gốc</h5>
                    <img src="static/images/img-500x500.jpg" class="img-thumbnail" style="width: 500px; height: 500px;" id="input">
                </div>
                <div class="col-6 text-center">
                    <h5>Kết quả</h5>
                    <img src="static/images/img-500x500.jpg" class="img-thumbnail" style="width: 500px; height: 500px;" id="output">
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div id="table-container" style="display: none;">
                        <h4 class="text-center mt-4 mb-3">Kết quả nhận diện</h4>
                        <table id="detect-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Tên loại bệnh</th>
                                    <th>Dấu hiệu</th>
                                    <th>Cách trị</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- JavaScript sẽ render kết quả vào đây -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-section" class="content-section">
            <div class="row">
                <div class="col">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Ảnh gốc</th>
                                    <th>Ảnh nhận diện</th>
                                    <th>Kết quả</th>
                                    <th>Ngày nhận diện</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="history-body">
                                <tr>
                                    <td colspan="6" class="text-center">Dữ liệu đang được tải...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="handbook-section" class="content-section">
    <div class="row d-flex align-items-stretch"> <!-- Thêm d-flex và align-items-stretch -->
        <div class="col-md-4 mb-4">
            <div class="card" style="min-height: 400px;"> <!-- Đặt chiều cao tối thiểu -->
                <img src="static/disease/domden.png" class="card-img-top" alt="Bệnh 1">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Bệnh đốm đen</h5>
                    <p class="card-text">Triệu chứng: Xuất hiện các đốm đen tròn trên lá, lá vàng và rụng sớm.</p>
                    <a href="#" class="btn btn-primary mt-auto">Xem chi tiết</a> <!-- mt-auto đẩy nút xuống dưới -->
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card" style="min-height: 400px;">
                <img src="static/disease/phantrang.png" class="card-img-top" alt="Bệnh 2">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Bệnh phấn trắng</h5>
                    <p class="card-text">Triệu chứng: Lá phủ lớp phấn trắng như bột, lá cong queo và khô.</p>
                    <a href="#" class="btn btn-primary mt-auto">Xem chi tiết</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card" style="min-height: 400px;">
                <img src="static/disease/sauanla.jpg" class="card-img-top" alt="Bệnh 3">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Sâu xanh ăn lá</h5>
                    <p class="card-text">Triệu chứng: Sâu ăn phần biểu bì trên lá, sẽ tạo ra những màng mỏng màu trắng.</p>
                    <a href="#" class="btn btn-primary mt-auto">Xem chi tiết</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card" style="min-height: 400px;">
                <img src="static/disease/Suongmai.jpg" class="card-img-top" alt="Bệnh 3">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Bệnh sương mai</h5>
                    <p class="card-text">Triệu chứng: lá xuất hiện vệt màu xanh không định hình, sau biến thành màu vàng nâu hoặc màu tím tối.</p>
                    <a href="#" class="btn btn-primary mt-auto">Xem chi tiết</a>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            const titles = {
                'detect-section': 'PHÁT HIỆN BỆNH TRÊN LÁ HOA HỒNG',
                'history-section': 'LỊCH SỬ NHẬN DIỆN BỆNH',
                'handbook-section': 'SỔ TAY NHẬN DIỆN BỆNH'
            };
            document.getElementById('section-title').textContent = titles[sectionId];
            if (sectionId === 'history-section') {
                loadHistory();
            }
        }

        function readPath(event) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('input').src = e.target.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        function sendImage() {
            const fileInput = document.getElementById('img');
            const file = fileInput.files[0];
            if (!file) {
                alert("Vui lòng chọn ảnh.");
                return;
            }

            const formData = new FormData(document.getElementById('detectForm'));
            fetch('/detect', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert("Lỗi: " + data.error);
                    return;
                }
                if (!data.path) {
                    alert("Không thể xử lý ảnh. Vui lòng kiểm tra mô hình.");
                    document.getElementById('output').src = 'static/images/img-500x500.jpg';
                } else {
                    document.getElementById('output').src = data.path;
                }

                const tableContainer = document.getElementById('table-container');
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                let index = 0;
                for (const key in data) {
                    if (key !== 'path') {
                        const info = data[key];
                        const name = info.name || 'Không xác định'; // Giữ nguyên định dạng nhãn gốc
                        const row = `
                            <tr>
                                <td class="text-center">${index++}</td>
                                <td>${name}</td>
                                <td>${info.treatment || 'Không xác định'}</td>
                                <td>${info.guide || 'Không xác định'}</td>
                            </tr>`;
                        tbody.innerHTML += row;
                    }
                }
                tableContainer.style.display = 'block';
            })
            .catch(err => {
                console.error('Lỗi fetch:', err);
                alert("Có lỗi xảy ra khi xử lý ảnh. Kiểm tra console để biết thêm chi tiết.");
            });
        }

        function loadHistory() {
            fetch('/history')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('history-body');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Không có dữ liệu lịch sử.</td></tr>';
                        return;
                    }
                    data.forEach((item, index) => {
                        const row = `
                            <tr>
                                <td>${index}</td>
                                <td><img src="${item.original_image}" class="history-img"></td>
                                <td><img src="${item.detected_image}" class="history-img"></td>
                                <td>${item.result}</td>
                                <td>${item.date}</td>
                                <td><button class="btn btn-danger btn-sm" onclick="deleteHistory(${item.id})">Xóa</button></td>
                            </tr>`;
                        tbody.innerHTML += row;
                    });
                })
                .catch(err => {
                    console.error('Lỗi tải lịch sử:', err);
                    document.getElementById('history-body').innerHTML = '<tr><td colspan="6" class="text-center">Lỗi khi tải lịch sử.</td></tr>';
                });
        }

        function deleteHistory(id) {
            fetch(`/history/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) loadHistory();
                    else alert('Lỗi khi xóa lịch sử.');
                })
                .catch(err => console.error('Lỗi xóa lịch sử:', err));
        }

        window.addEventListener('load', () => {
            showSection('detect-section'); // Mặc định hiển thị section "Phát hiện bệnh"
        });
    </script>
</body>
</html>